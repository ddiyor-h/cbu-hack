# Анализ выбросов для модели предсказания дефолтов

## Оглавление
1. [Резюме и рекомендации](#резюме-и-рекомендации)
2. [Детальный анализ](#детальный-анализ)
3. [Обоснование решения](#обоснование-решения)

---

## Резюме и рекомендации

### ✅ РЕКОМЕНДАЦИЯ: НЕ ОБРАБАТЫВАТЬ ВЫБРОСЫ

**Краткое обоснование:**
- Выбросы в кредитных данных несут полезную информацию о риске
- Древовидные модели (XGBoost, LightGBM, CatBoost) устойчивы к выбросам
- Обработка выбросов может снизить качество модели (AUC)
- В данных не обнаружено ошибок - все выбросы легитимны

---

## Детальный анализ

### 1. Методология анализа

Использовались три подхода к обнаружению выбросов:

#### 1.1. Метод межквартильного размаха (IQR)
- **Формула**: выбросы = значения < Q1 - 1.5×IQR или > Q3 + 1.5×IQR
- **Где**: Q1 = 25-й перцентиль, Q3 = 75-й перцентиль, IQR = Q3 - Q1

#### 1.2. Метод Z-score
- **Формула**: выбросы = |z-score| > 3
- **Где**: z = (значение - среднее) / стандартное отклонение

#### 1.3. Доменный анализ (Domain Knowledge)
- Проверка на нереалистичные значения в контексте кредитования
- Поиск ошибок данных (отрицательные доходы, нереальный возраст и т.д.)

### 2. Результаты анализа

#### 2.1. Топ-15 признаков с выбросами (метод IQR)

Большинство выбросов обнаружено в **бинарных признаках** (one-hot кодирование):

| Признак | Количество выбросов | % от общего | Тип признака |
|---------|---------------------|-------------|--------------|
| loan_purpose_Revolving Credit | 17,748 | 24.7% | Бинарный (0/1) |
| credit_util_category_low | 17,246 | 24.0% | Бинарный (0/1) |
| education_Some College | 17,126 | 23.8% | Бинарный (0/1) |
| employment_stability_medium | 15,784 | 21.9% | Бинарный (0/1) |
| loan_purpose_Home Purchase | 15,160 | 21.1% | Бинарный (0/1) |

**Важно**: Для бинарных признаков (0/1) метод IQR технически некорректен, т.к. такие признаки имеют дискретное распределение.

#### 2.2. Топ-15 признаков с выбросами (метод Z-score)

| Признак | Количество выбросов | % от общего |
|---------|---------------------|-------------|
| preferred_contact_Mail | 7,120 | 9.9% |
| loan_purpose_Home Improvement | 5,922 | 8.2% |
| loan_purpose_Major Purchase | 5,756 | 8.0% |
| employment_type_Part Time | 5,419 | 7.5% |
| num_public_records | 5,282 | 7.3% |

#### 2.3. Доменный анализ

##### Возраст (age)
- **Минимум**: 18 лет ✅
- **Максимум**: 74 года ✅
- **Нереалистичных значений**: 0 ✅

##### Доходы (income)
- **Отрицательных значений**: 0 ✅
- **Максимальный annual_income**: $487,200 (реалистично для высокооплачиваемых клиентов)
- **Максимальный monthly_income**: $40,600 (соответствует $487,200/12)

##### Задолженность (debt)
- **Отрицательных значений**: 0 ✅
- **Максимальный total_debt_amount**: $954,700 (реалистично для крупных кредитов)
- **Максимальный existing_monthly_debt**: $9,230

##### Кредитная нагрузка (credit_utilization)
- **Минимум**: 0.01 (1%) ✅
- **Максимум**: 1.00 (100%) ✅
- **Значений > 100%**: 0 ✅

##### Финансовые коэффициенты
| Коэффициент | Минимум | Максимум | Медиана |
|-------------|---------|----------|---------|
| debt_to_income_ratio | 0.05 | 0.40 | 0.23 |
| debt_service_ratio | 0.05 | 4.63 | 0.42 |
| payment_to_income_ratio | 0.002 | 4.53 | 0.17 |
| loan_to_value_ratio | 0.00 | 0.97 | 0.00 |

**Вывод**: Все значения находятся в пределах реалистичных для кредитной индустрии.

### 3. Влияние выбросов на целевую переменную (default)

Проанализировали, коррелируют ли выбросы с вероятностью дефолта:

| Признак | Default rate (выбросы) | Default rate (норма) | Разница |
|---------|------------------------|----------------------|---------|
| debt_service_ratio | 18.9% | 4.0% | **+14.9%** ⚠️ |
| payment_to_income_ratio | 18.0% | 3.9% | **+14.1%** ⚠️ |
| monthly_payment | 15.6% | 4.6% | **+11.0%** ⚠️ |
| credit_utilization | 14.3% | 5.1% | **+9.3%** ⚠️ |

**Критически важный вывод**:
- Выбросы в финансовых коэффициентах **СИЛЬНО коррелируют с дефолтом**
- Клиенты с экстремально высокими долговыми коэффициентами дефолтят в 4-5 раз чаще
- Эта информация **критична для модели** - удаление выбросов приведет к потере предсказательной силы

---

## Обоснование решения

### Почему НЕ обрабатывать выбросы?

#### 1. Выбросы информативны
- Экстремальные значения долговых коэффициентов **предсказывают дефолт**
- Удаление/ограничение выбросов = **потеря важной информации**
- AUC модели будет **ниже** без этих данных

#### 2. Выбросы легитимны
- **Нет ошибок данных**: возраст [18-74], доходы > 0, нет отрицательных балансов
- Экстремальные значения отражают **реальное разнообразие клиентов**
- Высокие доходы ($487K) и большие долги ($954K) существуют в реальности

#### 3. Устойчивость алгоритмов
Древовидные модели (наш основной инструмент) **устойчивы к выбросам**:

**XGBoost / LightGBM / CatBoost:**
- Используют пороговые сплиты: `if debt_ratio > 0.8 then high_risk`
- **Не важно**, что максимум = 4.63 вместо 2.0
- Важно только, что значение **больше порога**
- Выбросы не искажают модель, как в линейной регрессии

#### 4. Обобщение на тестовые данные
- В тестовой выборке **тоже будут выбросы**
- Модель должна уметь их обрабатывать
- Если удалить выбросы из обучения, модель не научится их предсказывать

### Когда МОЖНО было бы обрабатывать выбросы?

Обработка имела бы смысл только если:

1. **Ошибки данных** (не обнаружены):
   - Возраст = 999 лет
   - Отрицательный доход
   - Долг > 100 млрд долларов

2. **Линейные модели** (не планируются):
   - Логистическая регрессия чувствительна к выбросам
   - Но мы используем древовидные модели

3. **Сильное переобучение** (проверим позже):
   - Если train AUC >> validation AUC
   - Только тогда можно попробовать winsorization

### Альтернативные стратегии (если понадобятся)

Если модель переобучается, можно попробовать:

#### Winsorization (ограничение, не удаление)
```python
from scipy.stats.mstats import winsorize
X_train['debt_ratio'] = winsorize(X_train['debt_ratio'], limits=[0.01, 0.01])
```
- Ограничивает на уровне 1-го и 99-го перцентилей
- Сохраняет все наблюдения
- Уменьшает влияние экстремальных значений

#### Log-трансформация
```python
X_train['income_log'] = np.log1p(X_train['annual_income'])
```
- Сжимает распределение
- Полезно для сильно скошенных признаков
- Но для древовидных моделей обычно не нужно

#### Отсечение по перцентилям
```python
# Удалить только крайние 0.1%
upper_limit = X_train['debt_ratio'].quantile(0.999)
X_train = X_train[X_train['debt_ratio'] <= upper_limit]
```
- Крайняя мера
- Только если есть явные выбросы-ошибки

---

## План действий

### Шаг 1: Обучить модель БЕЗ обработки выбросов
```bash
python train_baseline_model.py
```

### Шаг 2: Проверить переобучение
- Сравнить train AUC vs validation AUC
- Если разница < 0.05 → всё ОК
- Если разница > 0.10 → возможно переобучение

### Шаг 3: Если переобучение - попробовать:
1. Увеличить регуляризацию (max_depth, min_child_weight)
2. Early stopping
3. Только после этого - winsorization

### Шаг 4: Сравнить AUC
- Без обработки выбросов: AUC = ?
- С winsorization: AUC = ?
- **Выбрать лучший вариант**

---

## Сохраненные файлы

Результаты анализа сохранены в:

1. `/home/dr/cbu/outlier_analysis_iqr.csv` - детальная статистика по методу IQR
2. `/home/dr/cbu/outlier_analysis_zscore.csv` - детальная статистика по методу Z-score

Для просмотра:
```bash
cat /home/dr/cbu/outlier_analysis_iqr.csv | head -20
```

---

## Заключение

**Выбросы в наших данных - это не шум, а сигнал.**

Клиенты с экстремальными долговыми коэффициентами дефолтят в 5 раз чаще. Удаление этих наблюдений приведет к потере критически важной информации для модели.

**Рекомендация: начать обучение без обработки выбросов, отслеживать метрики, корректировать только при необходимости.**
